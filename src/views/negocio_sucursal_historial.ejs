<%- include('partials/_header') %>


<div class="container">
    <div class="row mt-5">
        <div class="col-md-12">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header text-black">
                        <h5>HISTORIAL - <%= razon_social %> (SUCURSAL: <%= nombre_sucursal %>)</h5>
                    </div>
                </div>
            </div>
            
           

            <div class="btn-group  mt-4 fs-5" role="group" aria-label="bs-component">
                   
              <div class="col-5">
                <label class="form-label" for="fecha_desde">
                  DESDE:
                </label>
                <input class="form-input" type="datetime-local" name="fecha_desde" value="<%= fecha_desde %>" id="fecha_desde">
              </div>
                <div class="col-5">
                  <label class="form-label" for="fecha_hasta">
                    HASTA:
                  </label>
                  <input class="form-input" type="datetime-local" name="fecha_hasta" value="<%= fecha_hasta %>" id="fecha_hasta">
                </div>
                  <div class="col-5 pt-4">
                    <input class="btn btn-primary mt-2" type="button" value="BUSCAR" id="btnBuscar">
                  </div>
                  
            </div>


            <div class="col-12 mt-3 d-flex text-right" style="overflow: auto;">
            <table id="mitabla" class="table table-bordered table-hover mitabla" style="white-space: nowrap;">
                <thead class="bg-dark text-white header" >
                    <tr style="position: sticky;top: 0;">
                      <th>FECHA</th>
                        <th>SUCURSAL</th>
                        <th>APERTURA</th>
                        <th>CIERRE</th>
                        <th>CATEGORIA</th>
                        <th>PROVINCIA</th>
                        <th>MUNICIPIO</th>
                        <th>SECTOR</th>
                        <th>DIRECCIÓN</th>
                        <th>GEO LOCALIZACIÓN</th>
                        <th>CÓDIGO POSTAL</th>
                        <th>REFERENCIA 1</th>
                        <th>REFERENCIA 2</th>
                        <th>REFERENCIA 3</th>
                        <th>ZONA</th>
                        <th>SUBZONA</th>
                        <th>EJECUTIVO INTERNO</th>
                        <th>EJECUTIVO BANCO</th>
                        <th>EJECUTIVO PAGO</th>
                        <th>CONTACTO SUCURSAL</th>
                        <th>FAX</th>
                        <th>EMAIL</th>
                        <th>CÓDIGO FIDELIUM</th>
                        <th>CANT. LECTORES</th>
                        <th>DESCUENTO OTORGADO</th>
                        <th>DESCUENTO REDENCIÓN</th>
                        <th>LÍMITE DE PISO</th>
                        <th>BANCO</th>
                        <th>TIPO DE CUENTA</th>
                        <th>FRECUENCIA DE PAGO VIA CHEQUE</th>
                        <th>CUENTA DÉBITO</th>
                        <th>CUENTA CRÉDITO</th>
                        <th>ESTADO</th>
                        <th>AFILIADOS CARNET</th>
                        <th style="white-space: nowrap">RESPONSABLES SUCURSAL</th>
                        <th>CREADO POR</th>
                        <th>EDITADO POR</th>
                    </tr>
                </thead>
                <tbody id="tabla_sucursal">
                  <% if(historial) { var k = 1%>
                    <% for(var i =0;i < historial.length;i++){ %>

                          <tr class="table-active">
                           
                                <tr class="">
                                    <% k = 1; %>
                            <td><%= historial[i].fecha %></td>
                            <td><%= historial[i].nombre_sucursal %></td>
                            <td><%= historial[i].apertura %></td>
                            <td><%= historial[i].cierre %></td>
                            <td><%= historial[i].categoria %></td>
                            <td><%= historial[i].provincia %></td>
                            <td><%= historial[i].municipio %></td>
                            <td><%= historial[i].sector %></td>
                            <td><%= historial[i].direccion %></td>
                            <td><%= historial[i].geo %></td>
                            <td><%= historial[i].codigo_postal %></td>
                            <td><%= historial[i].referencia1 %></td>
                            <td><%= historial[i].referencia2 %></td>
                            <td><%= historial[i].referencia3 %></td>
                            <td><%= historial[i].zona %></td>
                            <td><%= historial[i].subzona %></td>
                            <td><%= historial[i].ejecutivointerno %></td>
                            <td><%= historial[i].ejecutivobanco %></td>
                            <td><%= historial[i].ejecutivopago %></td>
                            <td><%= historial[i].telefono %></td>
                            <td><%= historial[i].fax %></td>
                            <td><%= historial[i].email %></td>
                            <td><%= historial[i].codigo_fidelium %></td>
                            <td><%= historial[i].cantidad_lectores %></td>
                            <td><%= historial[i].descuento_otorgado %></td>
                            <td><%= historial[i].descuento_redencion %></td>
                            <td><%= historial[i].limite_piso %></td>
                            <td><%= historial[i].banco %></td>
                            <td><%= historial[i].banco_tipo_cuenta %></td>
                            <td><%= historial[i].frecuencia_pago_cheque %></td>
                            <td><%= historial[i].cuenta_debito %></td>
                            <td><%= historial[i].cuenta_credito %></td>
                            <td><%= historial[i].estado %></td>
                            <td><%= historial[i].losAfiliados %></td>
                            <td>
                              <table class="" style="white-space: nowrap">
                                <thead class="bg-dark text-white">
                                  <tr>
                                    <th>Nombre</th>
                                    <th>Cargo</th>
                                    <th>Celular</th>
                                    <th>Correo</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <% if(historial[i].responsable) { var k = 1%>
                                    <% for(var k =0;k < historial[i].responsable.length;k++){ %>
                                      <tr>
                                        <td><%= historial[i].responsable[k].nombre_persona_suc %></td>
                                        <td><%= historial[i].responsable[k].cargo_pers_suc %></td>
                                        <td><%= historial[i].responsable[k].telefono_pers_suc %></td>
                                        <td><%= historial[i].responsable[k].correo %></td>
                                      </tr>
                                    <% } %>
                                  <% } %>
                                </tbody>

                              </table>
                          
                            </td>
                            <td><%= historial[i].creadopor %></td>
                            <td><%= historial[i].edita %></td>
                                                        
                        </tr>
                   
                     <% } %>
                    <% } %>
                </tbody>
            </table>
            
            </div>
            <div id="paginacion" class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
            
          </div>
        </div>
        
    </div>
</div>

<script >


  function sucursalHistorial(inicio) { // el id que llega es el id del departamento
 
    const jsonAccesos = '<%- JSON.stringify(accesos) %>';
    var accesos = JSON.parse(jsonAccesos);
    //////
    let fecha_desde = document.getElementById('fecha_desde').value;
    let fecha_hasta = document.getElementById('fecha_hasta').value;
    if(fecha_desde == ''){
      alert('La fecha DESDE no puede ser nula')
      // fecha_hasta = moment().format('YYYY-MM-DD HH:mm:ss');
      // fecha_desde = moment().add(-1, 'd').format('YYYY-MM-DD HH:mm:ss');
    } else if(fecha_hasta ==''){
      alert('La fecha HASTA no puede ser nula');
      // fecha_hasta = moment().format('YYYY-MM-DD HH:mm:ss');
      // fecha_desde = moment().add(-1, 'd').format('YYYY-MM-DD HH:mm:ss');
    }
    else{
    let id_sucursal ="<%= id_sucursal %>";
    // console.log(id_sucursal)
    
    ///negocio/historial/${data[i].id_sucursal}/${1}/${ayer}/${ahora}  /:id/:inicio/:fecha_desde/:fecha_hasta
    $.get("/form_data/historial_filtro_sucursal/" + id_sucursal+'/'+inicio+'/'+fecha_desde+'/'+fecha_hasta, function (data) {
        console.log(data)
        var html = "";
        for(var i =0;i < data.length-1;i++){ 

            //console.log(data.length);                              
              html +="<tr>";
              // html +=`<td><a href="/negocio/update/${data[i].id_negocio}" style="text-decoration:none;color: blue;font-size: large;">${data[i].razon_social}</a></td>`;
              html +="<td>"+ data[i].fecha +"</td>";
              html +="<td>"+ data[i].nombre_sucursal +"</td>";
              html +="<td>"+ data[i].apertura +"</td>";
              html +="<td>"+ data[i].cierre +"</td>";
              html +="<td>"+ data[i].categoria +"</td>";
              html +="<td>"+ data[i].provincia +"</td>";
              html +="<td>"+ data[i].municipio +"</td>";
              html +="<td>"+ data[i].sector +"</td>";
              html +="<td>"+ data[i].direccion +"</td>";
              html +="<td>"+ data[i].geo +"</td>";
              html +="<td>"+ data[i].codigo_postal +"</td>";
              html +="<td>"+ data[i].referencia1 +"</td>";
              html +="<td>"+ data[i].referencia2 +"</td>";
              html +="<td>"+ data[i].referencia3 +"</td>";
              html +="<td>"+ data[i].zona +"</td>";
              html +="<td>"+ data[i].subzona +"</td>";
              html +="<td>"+ data[i].ejecutivointerno +"</td>";
              html +="<td>"+ data[i].ejecutivobanco +"</td>";
              html +="<td>"+ data[i].ejecutivopago +"</td>";
              html +="<td>"+ data[i].telefono +"</td>";
              html +="<td>"+ data[i].fax +"</td>";
              html +="<td>"+ data[i].email +"</td>";
              html +="<td>"+ data[i].codigo_fidelium +"</td>";
              html +="<td>"+ data[i].cantidad_lectores +"</td>";
              html +="<td>"+ data[i].descuento_otorgado +"</td>";
              html +="<td>"+ data[i].descuento_redencion +"</td>";
              html +="<td>"+ data[i].limite_piso +"</td>";
              html +="<td>"+ data[i].banco +"</td>";
              html +="<td>"+ data[i].banco_tipo_cuenta +"</td>";
              html +="<td>"+ data[i].frecuencia_pago_cheque +"</td>";
              html +="<td>"+ data[i].cuenta_debito +"</td>";
              html +="<td>"+ data[i].cuenta_credito +"</td>";
              html +="<td>"+ data[i].estado +"</td>";
              html +="<td>"+ data[i].losAfiliados +"</td>";
              html +=`<td>
                <table class="" style="white-space: nowrap"> 
                  <thead class="bg-dark text-white">
                    <tr>
                      <th>Nombre</th>
                      <th>Cargo</th>
                      <th>Celular</th>
                      <th>Correo</th>
                    </tr>
                  </thead>
                  <tbody>
                  `;
                  if(data[i].responsable) {
                    for(var k =0;k < data[i].responsable.length;k++){ 
                        html +="<tr>";
                        html +="<td>" +data[i].responsable[k].nombre_persona_suc +"</td>";
                        html +="<td>" +data[i].responsable[k].cargo_pers_suc +"</td>";
                        html +="<td>" +data[i].responsable[k].telefono_pers_suc +"</td>";
                        html +="<td>" +data[i].responsable[k].correo +"</td>";
                        html +="</tr>";
                    } 
                  } 
              html +=`</td></tbody>
                      </table>`;

              html +="<td>"+ data[i].creadopor +"</td>";
              html +="<td>"+ data[i].edita +"</td>";
              html +="</tr>";  
               
          }
        var elementTabla_empleado = document.getElementById("tabla_sucursal");
        elementTabla_empleado.innerHTML = html;
        // console.log('No se cuantos son: ',data[data.length-1].registros[0][0].total)
// console.log('No se cuantos son: ',)
cargaPaginacion(data[data.length-1].registros[0][0].total,inicio)
    //     totalregistros = data[data.length-1].registros[0][0].total;
		// nrolink = Math.ceil(totalregistros/10);
		// paginador = "<ul class='pagination'>";
		// campobuscar = $('#buscar').val();
		// for(i=1;i<=nrolink;i++){
		// 	if(i===inicio){
		// 		paginador += "<li class='active'><a href='javascript:void(0)'>"+i+"</li>";
		// 	}else{
		// 		paginador+="<li><a href='javascript:void(0)' onclick='listar_empleados("+'"'+campobuscar+'","'+i+'"'+");'>"+i+"</a></li>";
		// 	}
		// }
		// paginador += "</ul>"
		// $('#paginacion').html(paginador);
        
    });
  }
  }
  
  function fechaActual(){
    date = new Date();
    year = date.getFullYear();
    month = date.getMonth() + 1;
    day = date.getDate();
    return  day + "/" + month + "/" + year;
    
  }
   function cargaPaginacion(cantidad_registros,inicio){
    nrolink = Math.ceil(cantidad_registros/paginacion);
    ht =`<div class="btn-group me-2" role="group" aria-label="First group">`;
      if(inicio == 1){
        
      }else{
        ht+=`<button type="button" onclick='sucursalHistorial(1);' class="btn btn-secondary"><<</button>`
        ht+=`<button type="button" onclick='sucursalHistorial(${inicio-1});' class="btn btn-secondary"><</button>`
      }
    for(i=1;i<=nrolink;i++){
      if(inicio == i){
        ht+=`<button type="button" onclick='sucursalHistorial(${i});' class="btn btn-primary">${i}</button>`
      }
      else{
        ht+=`<button type="button" onclick='sucursalHistorial(${i});' class="btn btn-secondary">${i}</button>`
      }
      
    }
    if(inicio == nrolink){

    }else{
      if(inicio == 0){
        ht+=`No hay registro`;
      }else{
        if(nrolink !=0){
          ht+=`<button type="button" onclick='sucursalHistorial(${inicio+1});' class="btn btn-secondary">></button>`
          ht+=`<button type="button" onclick='sucursalHistorial(${nrolink});' class="btn btn-secondary">>></button>`
        }
        else{
          ht+=`No hay registro`;
        }
        
      }
    }
    ht +=`</div>`;
    $('#paginacion').html(ht);
      // alert(cantidad_registros)
   }
  window.addEventListener('load', function() {
    let cantidad_registros ="<%= reg %>";
    cargaPaginacion(cantidad_registros,1)
    // sucursalHistorial()
    //const nacionalidad = document.getElementById("nacionalidad");
    //$("#fecha").val(fechaActual());
    //document.getElementById("fecha").value = new Date().toLocaleDateString();
    const radioButtons = document.querySelectorAll('input[name="optionsRadios"]');
    for (const radioButton of radioButtons) {
      radioButton.addEventListener('change', showSelected);
    }
    let radioSelected = 'Prospecto'
    function showSelected(e) {
      let valor = document.getElementById('buscar').value;
      if (this.checked) {

        if(valor ==""){
          valor ="aaaaaaaaaaaa";
        }
        // alert(`You selected ${this.id}`);
        radioSelected = this.id;
        negocioList(this.id,valor)
      }
    }


    document.getElementById("btnBuscar").onclick = function(e) {
      let fecha_desde = document.getElementById('fecha_desde').value;
        let fecha_hasta = document.getElementById('fecha_hasta').value;
        if(fecha_desde == ''){
          alert("La fecha DESDE no puede ser nula");
        }else if(fecha_hasta == ''){
          alert("La fecha HASTA no puede ser nula");
        }else if(fecha_hasta<fecha_desde){
          alert("la fecha inicial no puede ser mayor que la fecha final");          
        }else{
          inicio = 1;
          sucursalHistorial(inicio);
        }
    }
    // document.getElementById("inactivos").onclick = function(e) {
    //   let buscar = document.getElementById("buscar").value;
    //   if(buscar ==""){
    //     buscar ="aaaaaaaaaaaa";
    //   }
    //   empleadoList(buscar); 
    // };
    // document.getElementById("otros").onclick = function(e) {
    //   let buscar = document.getElementById("buscar").value;
    //   if(buscar ==""){
    //     buscar ="aaaaaaaaaaaa";
    //   }
    //   empleadoList(buscar); 
    // };
    // document.getElementById("afg").onclick = function(e) {
    //   let buscar = document.getElementById("buscar").value;
    //   if(buscar ==""){
    //     buscar ="aaaaaaaaaaaa";
    //   }
    //   empleadoList(buscar); 
    // };
    // document.getElementById("awm").onclick = function(e) {
    //   let buscar = document.getElementById("buscar").value;
    //   if(buscar ==""){
    //     buscar ="aaaaaaaaaaaa";
    //   }
    //   empleadoList(buscar); 
    // };
  
  });
  </script>
  <style>
   
  </style>
<%- include('partials/_footer') %>